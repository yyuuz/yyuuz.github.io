<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"/><meta name="theme-color" content="#222"/><meta http-equiv="X-UA-COMPATIBLE" content="IE=edge,chrome=1"/><meta name="renderer" content="webkit"/><link rel="icon" type="image/ico" sizes="32x32" href="/assets/favicon.ico"/><link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png"/><meta name="google-site-verification" content="gO2xul9Bk4QOdd449v2eDlMVfvj7_rJbRpeTc4NDHKY"/><link rel="alternate" href="/rss.xml" title="null" type="application/rss+xml"><link rel="alternate" href="/atom.xml" title="null" type="application/atom+xml"><link rel="alternate" type="application/json" href="https://yyuuz.github.io/feed.json"/><link rel="preconnect" href="https://s4.zstatic.net"/><link rel="preconnect" href="https://at.alicdn.com"/><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Mulish:400,400italic,700,700italic%7CFredericka%20the%20Great:400,400italic,700,700italic%7CNoto%20Serif%20JP:400,400italic,700,700italic%7CNoto%20Serif%20SC:400,400italic,700,700italic%7CInconsolata:400,400italic,700,700italic&display=swap&subset=latin,latin-ext" media="none" onload="this.media&#x3D;&#39;all&#39;"><link rel="stylesheet" href="/css/app.css?v=0.4.11"><link rel="modulepreload" href="/js/chunk-ABMFT7IW.js"></link><link rel="modulepreload" href="/js/chunk-CDYXBEUX.js"></link><link rel="modulepreload" href="/js/chunk-KBKEVC3M.js"></link><link rel="modulepreload" href="/js/chunk-WIQECBEN.js"></link><link rel="modulepreload" href="/js/chunk-WTGUYRS5.js"></link><link rel="modulepreload" href="/js/chunk-XKOPJS6Y.js"></link><link rel="modulepreload" href="/js/comments-KSAPHU3P.js"></link><link rel="modulepreload" href="/js/copy-tex-ECXRJCIR.js"></link><link rel="modulepreload" href="/js/index.esm-INIDXJUT.js"></link><link rel="modulepreload" href="/js/post-JLPUMNTD.js"></link><link rel="modulepreload" href="/js/quicklink-ULH37OPZ.js"></link><link rel="modulepreload" href="/js/search-4JHXEVSN.js"></link><link rel="modulepreload" href="/js/siteInit.js"></link><link rel="modulepreload" href="/js/waline-2AUA5EA7.js"></link><link rel="stylesheet" href="/css/comments-SJZAII77.css" media="none" onload="this.media&#x3D;&#39;all&#39;"></link><link rel="stylesheet" href="/css/siteInit.css" media="none" onload="this.media&#x3D;&#39;all&#39;"></link><link rel="stylesheet" href="/css/waline-ZFRMIHOE.css" media="none" onload="this.media&#x3D;&#39;all&#39;"></link><link rel="preload" href="https://pichost-yu.oss-cn-wuhan-lr.aliyuncs.com/shokax/img(13).webp" as="image" fetchpriority="high"><link rel="preload" href="https://pichost-yu.oss-cn-wuhan-lr.aliyuncs.com/shokax/img(7).webp" as="image" fetchpriority="high"><link rel="preload" href="https://pichost-yu.oss-cn-wuhan-lr.aliyuncs.com/shokax/img(78).webp" as="image" fetchpriority="high"><link rel="preload" href="https://pichost-yu.oss-cn-wuhan-lr.aliyuncs.com/shokax/img(56).webp" as="image" fetchpriority="high"><link rel="preload" href="https://pichost-yu.oss-cn-wuhan-lr.aliyuncs.com/shokax/img(82).webp" as="image" fetchpriority="high"><link rel="preload" href="https://pichost-yu.oss-cn-wuhan-lr.aliyuncs.com/shokax/img(18).webp" as="image" fetchpriority="high"><meta name="keywords" content="ANNS/索引,"/><link rel="canonical" href="https://yyuuz.github.io/2024/08/17/ANNS/%E5%86%8D%E8%AF%BBHNSW/"><title>再读HNSW</title><meta name="generator" content="Hexo 7.3.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">再读HNSW</h1><div class="meta"><span class="item" title="创建时间：2024-08-17 00:00:00"><span class="icon"><i class="ic i-calendar"></i></span><span class="text">发表于</span><time itemprop="dateCreated datePublished" datetime="2024-08-17T00:00:00+08:00">2024-08-17</time></span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i></span><span class="text">本文字数</span><span>15k</span><span class="text">字</span></span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i></span><span class="text">阅读时长</span><span>14 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span><span class="line"></span><span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Yyuuz's Wasteland</a></li></ul><ul class="right" id="rightNav"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div class="pjax" id="imgs"><ul><li class="item" style="background-image: url(&quot;https://pichost-yu.oss-cn-wuhan-lr.aliyuncs.com/shokax/img(13).webp&quot;);"></li><li class="item" style="background-image: url(&quot;https://pichost-yu.oss-cn-wuhan-lr.aliyuncs.com/shokax/img(7).webp&quot;);"></li><li class="item" style="background-image: url(&quot;https://pichost-yu.oss-cn-wuhan-lr.aliyuncs.com/shokax/img(78).webp&quot;);"></li><li class="item" style="background-image: url(&quot;https://pichost-yu.oss-cn-wuhan-lr.aliyuncs.com/shokax/img(56).webp&quot;);"></li><li class="item" style="background-image: url(&quot;https://pichost-yu.oss-cn-wuhan-lr.aliyuncs.com/shokax/img(82).webp&quot;);"></li><li class="item" style="background-image: url(&quot;https://pichost-yu.oss-cn-wuhan-lr.aliyuncs.com/shokax/img(18).webp&quot;);"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"></use><use xlink:href="#gentle-wave" x="48" y="3"></use><use xlink:href="#gentle-wave" x="48" y="5"></use><use xlink:href="#gentle-wave" x="48" y="7"></use></g></svg></div><main><div class="inner"><div class="pjax" id="main"><div class="article wrap"><div class="breadcrumb" itemListElement itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i><span><a href="/">首页</a></span><i class="ic i-angle-right"></i><span class="current" itemprop="itemListElement" itemscope="itemscope" itemtype="https://schema.org/ListItem"><a href="/categories/ANNS/" itemprop="item" rel="index" title="分类于ANNS"><span itemprop="name">ANNS<meta itemprop="position" content="0"/></span></a></span></div><article class="post block" itemscope="itemscope" itemtype="http://schema.org/Article" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://yyuuz.github.io/2024/08/17/ANNS/%E5%86%8D%E8%AF%BBHNSW/"/><span hidden="hidden" itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="image" content="/assets/avatar.webp"/><meta itemprop="name" content="GuitarYui"/><meta itemprop="description" content="In a champagne supernova in the sky, "/></span><span hidden="hidden" itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name"/></span><div class="body md" itemprop="articleBody"><p>关于索引构建的算法在 [[基于图的 ANNS 构建索引相关]] 中，本文将结合 HNSW 代码深入理解 HNSW 算法构建的细节</p>
<h1 id="参数分析"><a class="anchor" href="#参数分析">#</a> 参数分析</h1>
<h2 id="构建参数"><a class="anchor" href="#构建参数">#</a> 构建参数</h2>
<h3 id="层次选择"><a class="anchor" href="#层次选择">#</a> 层次选择</h3>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mo>←</mo><mo stretchy="false">⌊</mo><mo>−</mo><mi>l</mi><mi>n</mi><mo stretchy="false">(</mo><mi>u</mi><mi>n</mi><mi>i</mi><mi>f</mi><mo stretchy="false">(</mo><mn>0..1</mn><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo>⋅</mo><msub><mi>m</mi><mi>L</mi></msub><mo stretchy="false">⌋</mo></mrow><annotation encoding="application/x-tex">l←⌊−ln(unif(0..1))⋅m_L⌋</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">←</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">⌊</span><span class="mord">−</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">n</span><span class="mopen">(</span><span class="mord mathnormal">u</span><span class="mord mathnormal">ni</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord">0..1</span><span class="mclose">))</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">L</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">⌋</span></span></span></span><br />
由于  <code>ln(unif(0..1))</code>  的值是负数，并且乘以负号后变为正数，再乘以常数  <code>mL</code> ，生成的  <code>l</code>  值服从一种<strong>指数分布</strong>。层数越高，其出现的概率越小。这确保了大多数元素的层数较低，而极少数元素的层数会较高。<br />
在实际系统中，层数  <code>l</code>  是整数值，并且受到计算机内存和性能的限制，实际中元素的层数不可能无限增长。此外，HNSW 通常设定了一个最大层数的限制，以防止极端情况下层数过高。</p>
<h3 id="参数选择"><a class="anchor" href="#参数选择">#</a> 参数选择</h3>
<p>一个简单选择最优 mL 的方法是 1/ln (M)，2∙M 是 Mmax0 的一个不错选择<br />
<img loading="lazy" data-src="https://pichost-yu.oss-cn-wuhan-lr.aliyuncs.com/img/20240825000331.png" alt="image.png" /><br />
 对于启发式方法：中低维 / 高度聚类数据效果好，均匀和非常高维的数据无效果。</p>
<h2 id="用户参数"><a class="anchor" href="#用户参数">#</a> 用户参数</h2>
<p>用户剩下的唯一有意义的构造参数是 M。M 的合理范围是从 5 到 48。模拟结果表明，对于较低的召回率和 / 或较低维度的数据，较小的 M 通常可以产生更好的结果，而较大的 M 则更适合于高召回率和 / 或高维度的数据（见图 8 进行说明，Core i5 2400 CPU）。该参数还定义了算法的内存消耗（与 M 成正比），因此应谨慎选择。<br />
<img loading="lazy" data-src="https://pichost-yu.oss-cn-wuhan-lr.aliyuncs.com/img/20240817001540.png" alt="image.png" /></p>
<h1 id="复杂度分析"><a class="anchor" href="#复杂度分析">#</a> 复杂度分析</h1>
<h2 id="时间复杂度"><a class="anchor" href="#时间复杂度">#</a> 时间复杂度</h2>
<p>层内搜索的跳数<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mo>=</mo><mn>1</mn><mi mathvariant="normal">/</mi><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mi>e</mi><mi>x</mi><mi>p</mi><mo stretchy="false">(</mo><mo>−</mo><msub><mi>m</mi><mi>L</mi></msub><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">S=1/(1-exp(-m_L))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1/</span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">e</span><span class="mord mathnormal">x</span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord">−</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">L</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">))</span></span></span></span> 与数据集规模无关<br />
假设节点平均度数也为常数 C, 距离计算次数 CS<br />
 对于低维数据，最大层索引<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>l</mi><mi>o</mi><mi>g</mi><mo stretchy="false">(</mo><mi>N</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(log(N))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">))</span></span></span></span></p>
<h2 id="空间复杂度"><a class="anchor" href="#空间复杂度">#</a> 空间复杂度</h2>
<p>每个元素的连接数量为零层的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>M</mi><mrow><mi>m</mi><mi>a</mi><mi>x</mi><mn>0</mn></mrow></msub></mrow><annotation encoding="application/x-tex">M_{max0}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ma</span><span class="mord mathnormal mtight">x</span><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 和其他层的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>M</mi><mrow><mi>m</mi><mi>a</mi><mi>x</mi></mrow></msub></mrow><annotation encoding="application/x-tex">M_{max}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ma</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>。因此，每个元素的平均内存消耗为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msub><mi>M</mi><mrow><mi>m</mi><mi>a</mi><mi>x</mi><mn>0</mn></mrow></msub><mo>+</mo><msub><mi>m</mi><mi>L</mi></msub><mo>∙</mo><msub><mi>M</mi><mrow><mi>m</mi><mi>a</mi><mi>x</mi></mrow></msub><mo stretchy="false">)</mo><mo>∙</mo><mi>b</mi><mi>y</mi><mi>t</mi><mi>e</mi><mi>s</mi><mi mathvariant="normal">_</mi><mi>p</mi><mi>e</mi><mi>r</mi><mi mathvariant="normal">_</mi><mi>l</mi><mi>i</mi><mi>n</mi><mi>k</mi></mrow><annotation encoding="application/x-tex">(M_{max0}+m_L ∙M_{max})∙bytes\_per\_link</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ma</span><span class="mord mathnormal mtight">x</span><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.5945em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">L</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∙</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ma</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∙</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0044em;vertical-align:-0.31em;"></span><span class="mord mathnormal">b</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mord mathnormal">t</span><span class="mord mathnormal">es</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">p</span><span class="mord mathnormal" style="margin-right:0.02778em;">er</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal" style="margin-right:0.03148em;">ink</span></span></span></span></p>
<h1 id="进一步"><a class="anchor" href="#进一步">#</a> 进一步</h1>
<p>失去了分布式搜索的可能性。HNSW 结构中的搜索始终从顶层开始，因此该结构无法使用之前的相同技术进行分布式处理</p>
<h1 id="源码分析"><a class="anchor" href="#源码分析">#</a> 源码分析</h1>
<h2 id="数据结构"><a class="anchor" href="#数据结构">#</a> 数据结构</h2>
<h3 id="labeltype和tableint"><a class="anchor" href="#labeltype和tableint">#</a> labeltype 和 tableint</h3>
<ul>
<li><code>labeltype</code>  是外部标签的类型，可能是  <code>int</code> 、 <code>string</code>  等类型，用于表示数据点的唯一外部标识。</li>
<li><code>tableint</code>  是节点的内部 ID 类型，在 HNSW 中定义为  <code>unsigned int</code> ，用于在图结构中唯一标识每个节点。</li>
<li>
<ul>
<li><strong> <code>labeltype</code> </strong>：用于表示节点的外部标签，用户通过它来引用和操作数据点。在外部系统中，用户通常使用  <code>labeltype</code>  来查找或标识节点。</li>
</ul>
</li>
<li><strong> <code>tableint</code> </strong>：用于表示节点的内部 ID，是在图中用于定位节点的唯一标识符。这个值是程序内部管理节点使用的，而不直接暴露给外部用户。</li>
</ul>
<h3 id="内存中节点"><a class="anchor" href="#内存中节点">#</a> 内存中节点</h3>
<p><img loading="lazy" data-src="https://pichost-yu.oss-cn-wuhan-lr.aliyuncs.com/img/917111494201114222.jpg" alt="917111494201114222.jpg" /></p>
<h2 id="插入点"><a class="anchor" href="#插入点">#</a> 插入点</h2>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre>tableint <span class="token function">addPoint</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>data_point<span class="token punctuation">,</span> labeltype label<span class="token punctuation">,</span> <span class="token keyword">int</span> level<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>        tableint cur_c <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>            <span class="token comment">// Checking if the element with the same label already exists</span></pre></td></tr><tr><td data-num="5"></td><td><pre>            <span class="token comment">// if so, updating it *instead* of creating a new element.</span></pre></td></tr><tr><td data-num="6"></td><td><pre>            std<span class="token double-colon punctuation">::</span>unique_lock <span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">></span> <span class="token function">lock_table</span><span class="token punctuation">(</span>label_lookup_lock<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>            <span class="token keyword">auto</span> search <span class="token operator">=</span> label_lookup_<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>label<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>search <span class="token operator">!=</span> label_lookup_<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 找到了相同的节点</span></pre></td></tr><tr><td data-num="9"></td><td><pre>                tableint existingInternalId <span class="token operator">=</span> search<span class="token operator">-></span>second<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>allow_replace_deleted_<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isMarkedDeleted</span><span class="token punctuation">(</span>existingInternalId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>                        <span class="token keyword">throw</span> std<span class="token double-colon punctuation">::</span><span class="token function">runtime_error</span><span class="token punctuation">(</span><span class="token string">"Can't use addPoint to update deleted elements if replacement of deleted elements is enabled."</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>                lock_table<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isMarkedDeleted</span><span class="token punctuation">(</span>existingInternalId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>                    <span class="token function">unmarkDeletedInternal</span><span class="token punctuation">(</span>existingInternalId<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>                <span class="token punctuation">&#125;</span><span class="token comment">// 取消删除标记</span></pre></td></tr><tr><td data-num="20"></td><td><pre>                <span class="token function">updatePoint</span><span class="token punctuation">(</span>data_point<span class="token punctuation">,</span> existingInternalId<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>                <span class="token comment">// 通过 updatePoint 更新该节点的数据</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>                <span class="token keyword">return</span> existingInternalId<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>cur_element_count <span class="token operator">>=</span> max_elements_<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>                <span class="token keyword">throw</span> std<span class="token double-colon punctuation">::</span><span class="token function">runtime_error</span><span class="token punctuation">(</span><span class="token string">"The number of elements exceeds the specified limit"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>            cur_c <span class="token operator">=</span> cur_element_count<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>            cur_element_count<span class="token operator">++</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>            label_lookup_<span class="token punctuation">[</span>label<span class="token punctuation">]</span> <span class="token operator">=</span> cur_c<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>            <span class="token comment">// 函数生成一个新的 tableint 值 cur_c 作为新节点的内部 ID，并在 label_lookup_ 中建立 label 与 cur_c 的映射。</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>        std<span class="token double-colon punctuation">::</span>unique_lock <span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">></span> <span class="token function">lock_el</span><span class="token punctuation">(</span>link_list_locks_<span class="token punctuation">[</span>cur_c<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token keyword">int</span> curlevel <span class="token operator">=</span> <span class="token function">getRandomLevel</span><span class="token punctuation">(</span>mult_<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>level <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="39"></td><td><pre>            curlevel <span class="token operator">=</span> level<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre>        element_levels_<span class="token punctuation">[</span>cur_c<span class="token punctuation">]</span> <span class="token operator">=</span> curlevel<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        <span class="token comment">// 随机生成新节点的层数（或使用指定的层数），并将其记录在 element_levels_ 中。</span></pre></td></tr><tr><td data-num="43"></td><td><pre></pre></td></tr><tr><td data-num="44"></td><td><pre>        std<span class="token double-colon punctuation">::</span>unique_lock <span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">></span> <span class="token function">templock</span><span class="token punctuation">(</span>global<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>        <span class="token keyword">int</span> maxlevelcopy <span class="token operator">=</span> maxlevel_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>curlevel <span class="token operator">&lt;=</span> maxlevelcopy<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="47"></td><td><pre>            templock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>        tableint currObj <span class="token operator">=</span> enterpoint_node_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>        tableint enterpoint_copy <span class="token operator">=</span> enterpoint_node_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre></pre></td></tr><tr><td data-num="51"></td><td><pre>        <span class="token function">memset</span><span class="token punctuation">(</span>data_level0_memory_ <span class="token operator">+</span> cur_c <span class="token operator">*</span> size_data_per_element_ <span class="token operator">+</span> offsetLevel0_<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> size_data_per_element_<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre></pre></td></tr><tr><td data-num="53"></td><td><pre>        <span class="token comment">// Initialisation of the data and label</span></pre></td></tr><tr><td data-num="54"></td><td><pre>        <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token function">getExternalLabeLp</span><span class="token punctuation">(</span>cur_c<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>label<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>labeltype<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>        <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token function">getDataByInternalId</span><span class="token punctuation">(</span>cur_c<span class="token punctuation">)</span><span class="token punctuation">,</span> data_point<span class="token punctuation">,</span> data_size_<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre></pre></td></tr><tr><td data-num="57"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>curlevel<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>            linkLists_<span class="token punctuation">[</span>cur_c<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">malloc</span><span class="token punctuation">(</span>size_links_per_element_ <span class="token operator">*</span> curlevel <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>linkLists_<span class="token punctuation">[</span>cur_c<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="60"></td><td><pre>                <span class="token keyword">throw</span> std<span class="token double-colon punctuation">::</span><span class="token function">runtime_error</span><span class="token punctuation">(</span><span class="token string">"Not enough memory: addPoint failed to allocate linklist"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>            <span class="token function">memset</span><span class="token punctuation">(</span>linkLists_<span class="token punctuation">[</span>cur_c<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> size_links_per_element_ <span class="token operator">*</span> curlevel <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="63"></td><td><pre></pre></td></tr><tr><td data-num="64"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">signed</span><span class="token punctuation">)</span>currObj <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>curlevel <span class="token operator">&lt;</span> maxlevelcopy<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>                dist_t curdist <span class="token operator">=</span> <span class="token function">fstdistfunc_</span><span class="token punctuation">(</span>data_point<span class="token punctuation">,</span> <span class="token function">getDataByInternalId</span><span class="token punctuation">(</span>currObj<span class="token punctuation">)</span><span class="token punctuation">,</span> dist_func_param_<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> level <span class="token operator">=</span> maxlevelcopy<span class="token punctuation">;</span> level <span class="token operator">></span> curlevel<span class="token punctuation">;</span> level<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>                    <span class="token keyword">bool</span> changed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>                    <span class="token keyword">while</span> <span class="token punctuation">(</span>changed<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 不断更新当前最接近的数据点 currObj，直到找不到更接近的节点为止</span></pre></td></tr><tr><td data-num="70"></td><td><pre>                        changed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>                        <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span>data<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>                        std<span class="token double-colon punctuation">::</span>unique_lock <span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>link_list_locks_<span class="token punctuation">[</span>currObj<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>                        data <span class="token operator">=</span> <span class="token function">get_linklist</span><span class="token punctuation">(</span>currObj<span class="token punctuation">,</span> level<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>                        <span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token function">getListCount</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>                        <span class="token comment">// 获取当前节点在指定层的邻居列表，size 是邻居列表的大小。</span></pre></td></tr><tr><td data-num="76"></td><td><pre></pre></td></tr><tr><td data-num="77"></td><td><pre>                        tableint <span class="token operator">*</span>datal <span class="token operator">=</span> <span class="token punctuation">(</span>tableint <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>data <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>                        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>                            tableint cand <span class="token operator">=</span> datal<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>                            <span class="token keyword">if</span> <span class="token punctuation">(</span>cand <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> cand <span class="token operator">></span> max_elements_<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="81"></td><td><pre>                                <span class="token keyword">throw</span> std<span class="token double-colon punctuation">::</span><span class="token function">runtime_error</span><span class="token punctuation">(</span><span class="token string">"cand error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>                            dist_t d <span class="token operator">=</span> <span class="token function">fstdistfunc_</span><span class="token punctuation">(</span>data_point<span class="token punctuation">,</span> <span class="token function">getDataByInternalId</span><span class="token punctuation">(</span>cand<span class="token punctuation">)</span><span class="token punctuation">,</span> dist_func_param_<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 距离计算</span></pre></td></tr><tr><td data-num="83"></td><td><pre>                            <span class="token keyword">if</span> <span class="token punctuation">(</span>d <span class="token operator">&lt;</span> curdist<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>                                curdist <span class="token operator">=</span> d<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>                                currObj <span class="token operator">=</span> cand<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>                                changed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>                            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="88"></td><td><pre>                        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="89"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="90"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="91"></td><td><pre>            <span class="token punctuation">&#125;</span><span class="token comment">//todo</span></pre></td></tr><tr><td data-num="92"></td><td><pre></pre></td></tr><tr><td data-num="93"></td><td><pre>            <span class="token keyword">bool</span> epDeleted <span class="token operator">=</span> <span class="token function">isMarkedDeleted</span><span class="token punctuation">(</span>enterpoint_copy<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="94"></td><td><pre>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> level <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">min</span><span class="token punctuation">(</span>curlevel<span class="token punctuation">,</span> maxlevelcopy<span class="token punctuation">)</span><span class="token punctuation">;</span> level <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> level<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="95"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>level <span class="token operator">></span> maxlevelcopy <span class="token operator">||</span> level <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment">// possible?</span></pre></td></tr><tr><td data-num="96"></td><td><pre>                    <span class="token keyword">throw</span> std<span class="token double-colon punctuation">::</span><span class="token function">runtime_error</span><span class="token punctuation">(</span><span class="token string">"Level error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="97"></td><td><pre></pre></td></tr><tr><td data-num="98"></td><td><pre>                std<span class="token double-colon punctuation">::</span>priority_queue<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>pair<span class="token operator">&lt;</span>dist_t<span class="token punctuation">,</span> tableint<span class="token operator">></span><span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>pair<span class="token operator">&lt;</span>dist_t<span class="token punctuation">,</span> tableint<span class="token operator">>></span><span class="token punctuation">,</span> CompareByFirst<span class="token operator">></span> top_candidates <span class="token operator">=</span> <span class="token function">searchBaseLayer</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="99"></td><td><pre>                        currObj<span class="token punctuation">,</span> data_point<span class="token punctuation">,</span> level<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="100"></td><td><pre>                        <span class="token comment">//searchBaseLayer 函数会在指定的 level 层进行搜索，寻找与当前节点 data_point 最近的候选邻居节点，返回一个优先队列 top_candidates，队列中的元素按照距离排序，距离越近的节点排在前面。</span></pre></td></tr><tr><td data-num="101"></td><td><pre>                        <span class="token comment">// 和论文的算法不一样，这里的 ep:currObj 仍然只有一个</span></pre></td></tr><tr><td data-num="102"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>epDeleted<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="103"></td><td><pre>                    top_candidates<span class="token punctuation">.</span><span class="token function">emplace</span><span class="token punctuation">(</span><span class="token function">fstdistfunc_</span><span class="token punctuation">(</span>data_point<span class="token punctuation">,</span> <span class="token function">getDataByInternalId</span><span class="token punctuation">(</span>enterpoint_copy<span class="token punctuation">)</span><span class="token punctuation">,</span> dist_func_param_<span class="token punctuation">)</span><span class="token punctuation">,</span> enterpoint_copy<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="104"></td><td><pre>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>top_candidates<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> ef_construction_<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="105"></td><td><pre>                        top_candidates<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="106"></td><td><pre>                <span class="token punctuation">&#125;</span><span class="token comment">// 如果入口点 enterpoint_copy 被标记为已删除，则将其作为候选节点之一加入到 top_candidates 中，因为入口节点很重要？</span></pre></td></tr><tr><td data-num="107"></td><td><pre>                currObj <span class="token operator">=</span> <span class="token function">mutuallyConnectNewElement</span><span class="token punctuation">(</span>data_point<span class="token punctuation">,</span> cur_c<span class="token punctuation">,</span> top_candidates<span class="token punctuation">,</span> level<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="108"></td><td><pre>                <span class="token comment">// 在 level 层将新插入节点 cur_c 与 top_candidates 中的候选节点相互连接（双向连接）。</span></pre></td></tr><tr><td data-num="109"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="110"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="111"></td><td><pre>            <span class="token comment">// Do nothing for the first element</span></pre></td></tr><tr><td data-num="112"></td><td><pre>            enterpoint_node_ <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="113"></td><td><pre>            maxlevel_ <span class="token operator">=</span> curlevel<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="114"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="115"></td><td><pre></pre></td></tr><tr><td data-num="116"></td><td><pre>        <span class="token comment">// Releasing lock for the maximum level</span></pre></td></tr><tr><td data-num="117"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>curlevel <span class="token operator">></span> maxlevelcopy<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="118"></td><td><pre>            enterpoint_node_ <span class="token operator">=</span> cur_c<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="119"></td><td><pre>            maxlevel_ <span class="token operator">=</span> curlevel<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="120"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="121"></td><td><pre>        <span class="token keyword">return</span> cur_c<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="122"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="选择邻居以及更新邻接表"><a class="anchor" href="#选择邻居以及更新邻接表">#</a> 选择邻居以及更新邻接表</h3>
<figure class="highlight cpp"><figcaption data-lang="C++"><span>p</span></figcaption><table><tr><td data-num="1"></td><td><pre>tableint  <span class="token function">mutuallyConnectNewElement</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="2"></td><td><pre>        <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>data_point<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        tableint cur_c<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        std<span class="token double-colon punctuation">::</span>priority_queue<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>pair<span class="token operator">&lt;</span>dist_t<span class="token punctuation">,</span> tableint<span class="token operator">></span><span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>pair<span class="token operator">&lt;</span>dist_t<span class="token punctuation">,</span> tableint<span class="token operator">>></span><span class="token punctuation">,</span> CompareByFirst<span class="token operator">></span> <span class="token operator">&amp;</span>top_candidates<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token keyword">int</span> level<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token keyword">bool</span> isUpdate<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        size_t Mcurmax <span class="token operator">=</span> level <span class="token operator">?</span> maxM_ <span class="token operator">:</span> maxM0_<span class="token punctuation">;</span><span class="token comment">//Mcurmax: 决定了当前层的最大邻居数量。如果在第 0 层，邻居数上限为 maxM0_，否则为 maxM_。</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token function">getNeighborsByHeuristic2</span><span class="token punctuation">(</span>top_candidates<span class="token punctuation">,</span> M_<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 使用一种启发式方法从 top_candidates 中选择 M_个最优的邻居节点</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>top_candidates<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> M_<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token keyword">throw</span> std<span class="token double-colon punctuation">::</span><span class="token function">runtime_error</span><span class="token punctuation">(</span><span class="token string">"Should be not be more than M_ candidates returned by the heuristic"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>        std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>tableint<span class="token operator">></span> selectedNeighbors<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        selectedNeighbors<span class="token punctuation">.</span><span class="token function">reserve</span><span class="token punctuation">(</span>M_<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token keyword">while</span> <span class="token punctuation">(</span>top_candidates<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            selectedNeighbors<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>top_candidates<span class="token punctuation">.</span><span class="token function">top</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>second<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            top_candidates<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>        tableint next_closest_entry_point <span class="token operator">=</span> selectedNeighbors<span class="token punctuation">.</span><span class="token function">back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token comment">// 更新 cur 的邻接表</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            <span class="token comment">// lock only during the update</span></pre></td></tr><tr><td data-num="24"></td><td><pre>            <span class="token comment">// because during the addition the lock for cur_c is already acquired</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            std<span class="token double-colon punctuation">::</span>unique_lock <span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>link_list_locks_<span class="token punctuation">[</span>cur_c<span class="token punctuation">]</span><span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>defer_lock<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>isUpdate<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>                lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>            linklistsizeint <span class="token operator">*</span>ll_cur<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>level <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="31"></td><td><pre>                ll_cur <span class="token operator">=</span> <span class="token function">get_linklist0</span><span class="token punctuation">(</span>cur_c<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>            <span class="token keyword">else</span></pre></td></tr><tr><td data-num="33"></td><td><pre>                ll_cur <span class="token operator">=</span> <span class="token function">get_linklist</span><span class="token punctuation">(</span>cur_c<span class="token punctuation">,</span> level<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>ll_cur <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isUpdate<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>                <span class="token keyword">throw</span> std<span class="token double-colon punctuation">::</span><span class="token function">runtime_error</span><span class="token punctuation">(</span><span class="token string">"The newly inserted element should have blank link list"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>            <span class="token function">setListCount</span><span class="token punctuation">(</span>ll_cur<span class="token punctuation">,</span> selectedNeighbors<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>            tableint <span class="token operator">*</span>data <span class="token operator">=</span> <span class="token punctuation">(</span>tableint <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>ll_cur <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>            <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> idx <span class="token operator">&lt;</span> selectedNeighbors<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> idx<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isUpdate<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="42"></td><td><pre>                    <span class="token keyword">throw</span> std<span class="token double-colon punctuation">::</span><span class="token function">runtime_error</span><span class="token punctuation">(</span><span class="token string">"Possible memory corruption"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>level <span class="token operator">></span> element_levels_<span class="token punctuation">[</span>selectedNeighbors<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="44"></td><td><pre>                    <span class="token keyword">throw</span> std<span class="token double-colon punctuation">::</span><span class="token function">runtime_error</span><span class="token punctuation">(</span><span class="token string">"Trying to make a link on a non-existent level"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre>                data<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">=</span> selectedNeighbors<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>            <span class="token punctuation">&#125;</span><span class="token comment">// 将 selectedNeighbors 中的节点 ID 填充到当前节点的邻居列表中</span></pre></td></tr><tr><td data-num="48"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="49"></td><td><pre></pre></td></tr><tr><td data-num="50"></td><td><pre>        <span class="token comment">// 更新邻居节点的邻接表</span></pre></td></tr><tr><td data-num="51"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> idx <span class="token operator">&lt;</span> selectedNeighbors<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> idx<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>            std<span class="token double-colon punctuation">::</span>unique_lock <span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>link_list_locks_<span class="token punctuation">[</span>selectedNeighbors<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre></pre></td></tr><tr><td data-num="54"></td><td><pre>            linklistsizeint <span class="token operator">*</span>ll_other<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>level <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="56"></td><td><pre>                ll_other <span class="token operator">=</span> <span class="token function">get_linklist0</span><span class="token punctuation">(</span>selectedNeighbors<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>            <span class="token keyword">else</span></pre></td></tr><tr><td data-num="58"></td><td><pre>                ll_other <span class="token operator">=</span> <span class="token function">get_linklist</span><span class="token punctuation">(</span>selectedNeighbors<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">,</span> level<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre></pre></td></tr><tr><td data-num="60"></td><td><pre>            size_t sz_link_list_other <span class="token operator">=</span> <span class="token function">getListCount</span><span class="token punctuation">(</span>ll_other<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre></pre></td></tr><tr><td data-num="62"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>sz_link_list_other <span class="token operator">></span> Mcurmax<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="63"></td><td><pre>                <span class="token keyword">throw</span> std<span class="token double-colon punctuation">::</span><span class="token function">runtime_error</span><span class="token punctuation">(</span><span class="token string">"Bad value of sz_link_list_other"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>selectedNeighbors<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">==</span> cur_c<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="65"></td><td><pre>                <span class="token keyword">throw</span> std<span class="token double-colon punctuation">::</span><span class="token function">runtime_error</span><span class="token punctuation">(</span><span class="token string">"Trying to connect an element to itself"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>level <span class="token operator">></span> element_levels_<span class="token punctuation">[</span>selectedNeighbors<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="67"></td><td><pre>                <span class="token keyword">throw</span> std<span class="token double-colon punctuation">::</span><span class="token function">runtime_error</span><span class="token punctuation">(</span><span class="token string">"Trying to make a link on a non-existent level"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre></pre></td></tr><tr><td data-num="69"></td><td><pre>            tableint <span class="token operator">*</span>data <span class="token operator">=</span> <span class="token punctuation">(</span>tableint <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>ll_other <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre></pre></td></tr><tr><td data-num="71"></td><td><pre>            <span class="token keyword">bool</span> is_cur_c_present <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>isUpdate<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>                <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> sz_link_list_other<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">==</span> cur_c<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>                        is_cur_c_present <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>                        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="80"></td><td><pre></pre></td></tr><tr><td data-num="81"></td><td><pre>            <span class="token comment">// If cur_c is already present in the neighboring connections of `selectedNeighbors[idx]` then no need to modify any connections or run the heuristics.</span></pre></td></tr><tr><td data-num="82"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>is_cur_c_present<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="83"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>sz_link_list_other <span class="token operator">&lt;</span> Mcurmax<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 没有超过最大邻居数量</span></pre></td></tr><tr><td data-num="84"></td><td><pre>                    data<span class="token punctuation">[</span>sz_link_list_other<span class="token punctuation">]</span> <span class="token operator">=</span> cur_c<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>                    <span class="token function">setListCount</span><span class="token punctuation">(</span>ll_other<span class="token punctuation">,</span> sz_link_list_other <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>                    <span class="token comment">// finding the "weakest" element to replace it with the new one</span></pre></td></tr><tr><td data-num="88"></td><td><pre>                    dist_t d_max <span class="token operator">=</span> <span class="token function">fstdistfunc_</span><span class="token punctuation">(</span><span class="token function">getDataByInternalId</span><span class="token punctuation">(</span>cur_c<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getDataByInternalId</span><span class="token punctuation">(</span>selectedNeighbors<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="89"></td><td><pre>                                                dist_func_param_<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="90"></td><td><pre>                    <span class="token comment">// Heuristic:</span></pre></td></tr><tr><td data-num="91"></td><td><pre>                    std<span class="token double-colon punctuation">::</span>priority_queue<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>pair<span class="token operator">&lt;</span>dist_t<span class="token punctuation">,</span> tableint<span class="token operator">></span><span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>pair<span class="token operator">&lt;</span>dist_t<span class="token punctuation">,</span> tableint<span class="token operator">>></span><span class="token punctuation">,</span> CompareByFirst<span class="token operator">></span> candidates<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="92"></td><td><pre>                    candidates<span class="token punctuation">.</span><span class="token function">emplace</span><span class="token punctuation">(</span>d_max<span class="token punctuation">,</span> cur_c<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="93"></td><td><pre></pre></td></tr><tr><td data-num="94"></td><td><pre>                    <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> sz_link_list_other<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="95"></td><td><pre>                        candidates<span class="token punctuation">.</span><span class="token function">emplace</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="96"></td><td><pre>                                <span class="token function">fstdistfunc_</span><span class="token punctuation">(</span><span class="token function">getDataByInternalId</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getDataByInternalId</span><span class="token punctuation">(</span>selectedNeighbors<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="97"></td><td><pre>                                                dist_func_param_<span class="token punctuation">)</span><span class="token punctuation">,</span> data<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="98"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="99"></td><td><pre></pre></td></tr><tr><td data-num="100"></td><td><pre>                    <span class="token function">getNeighborsByHeuristic2</span><span class="token punctuation">(</span>candidates<span class="token punctuation">,</span> Mcurmax<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="101"></td><td><pre>                    <span class="token comment">// 将 cur 和已有节点 与这个 neighbor 的距离计算出来再次启发式筛选</span></pre></td></tr><tr><td data-num="102"></td><td><pre>                    <span class="token keyword">int</span> indx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="103"></td><td><pre>                    <span class="token keyword">while</span> <span class="token punctuation">(</span>candidates<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="104"></td><td><pre>                        data<span class="token punctuation">[</span>indx<span class="token punctuation">]</span> <span class="token operator">=</span> candidates<span class="token punctuation">.</span><span class="token function">top</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>second<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="105"></td><td><pre>                        candidates<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="106"></td><td><pre>                        indx<span class="token operator">++</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="107"></td><td><pre>                    <span class="token punctuation">&#125;</span><span class="token comment">// 重新填入邻接表</span></pre></td></tr><tr><td data-num="108"></td><td><pre></pre></td></tr><tr><td data-num="109"></td><td><pre>                    <span class="token function">setListCount</span><span class="token punctuation">(</span>ll_other<span class="token punctuation">,</span> indx<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="110"></td><td><pre>                    <span class="token comment">// Nearest K:</span></pre></td></tr><tr><td data-num="111"></td><td><pre>                    <span class="token comment">/*int indx = -1;</pre></td></tr><tr><td data-num="112"></td><td><pre>                    for (int j = 0; j &lt; sz_link_list_other; j++) &#123;</pre></td></tr><tr><td data-num="113"></td><td><pre>                        dist_t d = fstdistfunc_(getDataByInternalId(data[j]), getDataByInternalId(rez[idx]), dist_func_param_);</pre></td></tr><tr><td data-num="114"></td><td><pre>                        if (d > d_max) &#123;</pre></td></tr><tr><td data-num="115"></td><td><pre>                            indx = j;</pre></td></tr><tr><td data-num="116"></td><td><pre>                            d_max = d;</pre></td></tr><tr><td data-num="117"></td><td><pre>                        &#125;</pre></td></tr><tr><td data-num="118"></td><td><pre>                    &#125;</pre></td></tr><tr><td data-num="119"></td><td><pre>                    if (indx >= 0) &#123;</pre></td></tr><tr><td data-num="120"></td><td><pre>                        data[indx] = cur_c;</pre></td></tr><tr><td data-num="121"></td><td><pre>                    &#125; */</span></pre></td></tr><tr><td data-num="122"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="123"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="124"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="125"></td><td><pre></pre></td></tr><tr><td data-num="126"></td><td><pre>        <span class="token keyword">return</span> next_closest_entry_point<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="127"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="启发式选择邻居"><a class="anchor" href="#启发式选择邻居">#</a> 启发式选择邻居</h3>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token function">getNeighborsByHeuristic2</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="2"></td><td><pre>        std<span class="token double-colon punctuation">::</span>priority_queue<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>pair<span class="token operator">&lt;</span>dist_t<span class="token punctuation">,</span> tableint<span class="token operator">></span><span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>pair<span class="token operator">&lt;</span>dist_t<span class="token punctuation">,</span> tableint<span class="token operator">>></span><span class="token punctuation">,</span> CompareByFirst<span class="token operator">></span> <span class="token operator">&amp;</span>top_candidates<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token keyword">const</span> size_t M<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>top_candidates<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> M<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>            <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>        std<span class="token double-colon punctuation">::</span>priority_queue<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>pair<span class="token operator">&lt;</span>dist_t<span class="token punctuation">,</span> tableint<span class="token operator">>></span> queue_closest<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>pair<span class="token operator">&lt;</span>dist_t<span class="token punctuation">,</span> tableint<span class="token operator">>></span> return_list<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token keyword">while</span> <span class="token punctuation">(</span>top_candidates<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            queue_closest<span class="token punctuation">.</span><span class="token function">emplace</span><span class="token punctuation">(</span><span class="token operator">-</span>top_candidates<span class="token punctuation">.</span><span class="token function">top</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">,</span> top_candidates<span class="token punctuation">.</span><span class="token function">top</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>second<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            top_candidates<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token comment">// 新的优先队列保持距离从远到近的顺序</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token keyword">while</span> <span class="token punctuation">(</span>queue_closest<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>return_list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> M<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre>                <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            std<span class="token double-colon punctuation">::</span>pair<span class="token operator">&lt;</span>dist_t<span class="token punctuation">,</span> tableint<span class="token operator">></span> curent_pair <span class="token operator">=</span> queue_closest<span class="token punctuation">.</span><span class="token function">top</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            dist_t dist_to_query <span class="token operator">=</span> <span class="token operator">-</span>curent_pair<span class="token punctuation">.</span>first<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>            queue_closest<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token keyword">bool</span> good <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>            <span class="token keyword">for</span> <span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>pair<span class="token operator">&lt;</span>dist_t<span class="token punctuation">,</span> tableint<span class="token operator">></span> second_pair <span class="token operator">:</span> return_list<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>                dist_t curdist <span class="token operator">=</span></pre></td></tr><tr><td data-num="25"></td><td><pre>                        <span class="token function">fstdistfunc_</span><span class="token punctuation">(</span><span class="token function">getDataByInternalId</span><span class="token punctuation">(</span>second_pair<span class="token punctuation">.</span>second<span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="26"></td><td><pre>                                        <span class="token function">getDataByInternalId</span><span class="token punctuation">(</span>curent_pair<span class="token punctuation">.</span>second<span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="27"></td><td><pre>                                        dist_func_param_<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 距离计算</span></pre></td></tr><tr><td data-num="28"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>curdist <span class="token operator">&lt;</span> dist_to_query<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>                    good <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>                    <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>good<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>                return_list<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>curent_pair<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token comment">// 这里没有论文中补充至 M 个的步骤，也就是说会少于 M 个</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>pair<span class="token operator">&lt;</span>dist_t<span class="token punctuation">,</span> tableint<span class="token operator">></span> curent_pair <span class="token operator">:</span> return_list<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>            top_candidates<span class="token punctuation">.</span><span class="token function">emplace</span><span class="token punctuation">(</span><span class="token operator">-</span>curent_pair<span class="token punctuation">.</span>first<span class="token punctuation">,</span> curent_pair<span class="token punctuation">.</span>second<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h1 id="参考"><a class="anchor" href="#参考">#</a> 参考</h1>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_38156298/article/details/100085892">HNSW 算法原理与源码解读_hnsw 有多少层 - CSDN 博客</a><br />
<a target="_blank" rel="noopener" href="https://github.com/nmslib/hnswlib"> nmslib/hnswlib: Header-only C++/python library for fast approximate nearest neighbors (github.com)</a></p>
<div class="tags"><a href="/tags/ANNS-%E7%B4%A2%E5%BC%95/" rel="tag"><i class="ic i-tag"></i>ANNS/索引</a><a href="/tags/HNSW/" rel="tag"><i class="ic i-tag"></i>HNSW</a></div></div><footer><div class="meta"><span class="icon"><i class="ic i-eye"></i></span><span>此文章已被阅读次数:</span><span class="waline-pageview-count" id="twikoo_visitors" data-path="/2024/08/17/ANNS/再读HNSW/">正在加载...</span><span class="item"><span class="icon"><i class="ic i-calendar-check"></i></span><span class="text">更新于</span><time title="修改时间：2024-08-28 21:46:20" itemprop="dateModified" datetime="2024-08-28T21:46:20+08:00">2024-08-28</time></span></div><div class="reward"><button><i class="ic i-heartbeat"></i>赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img loading="lazy" data-src="/assets/wechatpay.webp" alt="GuitarYui 微信支付"/><p>微信支付</p></div><div><img loading="lazy" data-src="/assets/alipay.webp" alt="GuitarYui 支付宝"/><p>支付宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者：</strong>GuitarYui<i class="ic i-at"><em>@</em></i></li><li class="link"><strong>本文链接：</strong><a href="https://yyuuz.github.io/2024/08/17/ANNS/%E5%86%8D%E8%AF%BBHNSW/" title="再读HNSW">https://yyuuz.github.io/2024/08/17/ANNS/再读HNSW/</a></li><li class="license"><strong>版权声明：</strong>本站所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2024/08/10/BLOG/ShokaX%E4%B8%BB%E9%A2%98%E6%B7%BB%E5%8A%A0live2d+%E8%B5%84%E6%BA%90%E4%B8%8A%E4%BC%A0%E9%98%BF%E9%87%8C%E4%BA%91OSS/" rel="prev" itemprop="url" data-background-image="https:&#x2F;&#x2F;pichost-yu.oss-cn-wuhan-lr.aliyuncs.com&#x2F;shokax&#x2F;img(51).webp" title="ShokaX主题添加live2d+资源上传阿里云OSS"><span class="type">上一篇</span><span class="category"><i class="ic i-flag"></i>BLOG</span><h3>ShokaX主题添加live2d+资源上传阿里云OSS</h3></a></div><div class="item right"></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E6%95%B0%E5%88%86%E6%9E%90"><span class="toc-number">1.</span> <span class="toc-text"> 参数分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA%E5%8F%82%E6%95%B0"><span class="toc-number">1.1.</span> <span class="toc-text"> 构建参数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B1%82%E6%AC%A1%E9%80%89%E6%8B%A9"><span class="toc-number">1.1.1.</span> <span class="toc-text"> 层次选择</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E6%95%B0%E9%80%89%E6%8B%A9"><span class="toc-number">1.1.2.</span> <span class="toc-text"> 参数选择</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E5%8F%82%E6%95%B0"><span class="toc-number">1.2.</span> <span class="toc-text"> 用户参数</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A4%8D%E6%9D%82%E5%BA%A6%E5%88%86%E6%9E%90"><span class="toc-number">2.</span> <span class="toc-text"> 复杂度分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%B6%E9%97%B4%E5%A4%8D%E6%9D%82%E5%BA%A6"><span class="toc-number">2.1.</span> <span class="toc-text"> 时间复杂度</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A9%BA%E9%97%B4%E5%A4%8D%E6%9D%82%E5%BA%A6"><span class="toc-number">2.2.</span> <span class="toc-text"> 空间复杂度</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%BF%9B%E4%B8%80%E6%AD%A5"><span class="toc-number">3.</span> <span class="toc-text"> 进一步</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">4.</span> <span class="toc-text"> 源码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-number">4.1.</span> <span class="toc-text"> 数据结构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#labeltype%E5%92%8Ctableint"><span class="toc-number">4.1.1.</span> <span class="toc-text"> labeltype 和 tableint</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E4%B8%AD%E8%8A%82%E7%82%B9"><span class="toc-number">4.1.2.</span> <span class="toc-text"> 内存中节点</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8F%92%E5%85%A5%E7%82%B9"><span class="toc-number">4.2.</span> <span class="toc-text"> 插入点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%89%E6%8B%A9%E9%82%BB%E5%B1%85%E4%BB%A5%E5%8F%8A%E6%9B%B4%E6%96%B0%E9%82%BB%E6%8E%A5%E8%A1%A8"><span class="toc-number">4.2.1.</span> <span class="toc-text"> 选择邻居以及更新邻接表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8F%91%E5%BC%8F%E9%80%89%E6%8B%A9%E9%82%BB%E5%B1%85"><span class="toc-number">4.2.2.</span> <span class="toc-text"> 启发式选择邻居</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">5.</span> <span class="toc-text"> 参考</span></a></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li ><a href="/2024/08/01/ANNS/DF-GAS_%20a%20Distributed%20FPGA-as-a-Service%20Architecture%20towards%20Billion-Scale%20Graph-based%20Approximate%20Nearest%20Neighbor%20Search/" rel="bookmark" title="DF-GAS_ a Distributed FPGA-as-a-Service Architecture towards Billion-Scale Graph-based Approximate Nearest Neighbor Search">DF-GAS_ a Distributed FPGA-as-a-Service Architecture towards Billion-Scale Graph-based Approximate Nearest Neighbor Search</a></li><li ><a href="/2024/08/01/ANNS/Product%20Quantization/" rel="bookmark" title="Product Quantization">Product Quantization</a></li><li ><a href="/2024/08/01/ANNS/SONG/" rel="bookmark" title="SONG">SONG</a></li><li ><a href="/2024/08/09/ANNS/CXL-ANNS/" rel="bookmark" title="CXL-ANNS">CXL-ANNS</a></li><li ><a href="/2024/08/09/ANNS/%E5%9F%BA%E4%BA%8E%E5%9B%BE%E7%9A%84ANNS%E6%9E%84%E5%BB%BA%E7%B4%A2%E5%BC%95%E7%9B%B8%E5%85%B3/" rel="bookmark" title="基于图的ANNS构建索引相关">基于图的ANNS构建索引相关</a></li><li  class="active"><a href="/2024/08/17/ANNS/%E5%86%8D%E8%AF%BBHNSW/" rel="bookmark" title="再读HNSW">再读HNSW</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><img class="image" loading="lazy" decoding="async" itemprop="image" alt="GuitarYui" src="/assets/avatar.webp"/><p class="name" itemprop="name">GuitarYui</p><div class="description" itemprop="description"></div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">7</span><span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">2</span><span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">8</span><span class="name">标签</span></a></div></nav><div class="social"><a target="_blank" rel="noopener" href="https://github.com/yyuuz" class="item github" title="https:&#x2F;&#x2F;github.com&#x2F;yyuuz"><i class="ic i-github"></i></a><a target="_blank" rel="noopener" href="https://music.163.com/#/user/home?id=1658614535" class="item music" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;1658614535"><i class="ic i-cloud-music"></i></a><a target="_blank" rel="noopener" href="https://steamcommunity.com/profiles/76561199098627022/" class="item steam" title="https:&#x2F;&#x2F;steamcommunity.com&#x2F;profiles&#x2F;76561199098627022&#x2F;"><i class="ic i-steam"></i></a></div><div class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item dropdown"><a href="#" onclick="return false;"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>友链</a></li></div></div></div></div><ul id="quick"><li class="prev pjax"></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/2024/08/10/BLOG/ShokaX%E4%B8%BB%E9%A2%98%E6%B7%BB%E5%8A%A0live2d+%E8%B5%84%E6%BA%90%E4%B8%8A%E4%BC%A0%E9%98%BF%E9%87%8C%E4%BA%91OSS/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/ANNS/" title="分类于ANNS">ANNS</a></div><span><a href="/2024/08/01/ANNS/SONG/">SONG</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/BLOG/" title="分类于BLOG">BLOG</a></div><span><a href="/2024/08/10/BLOG/ShokaX%E4%B8%BB%E9%A2%98%E6%B7%BB%E5%8A%A0live2d+%E8%B5%84%E6%BA%90%E4%B8%8A%E4%BC%A0%E9%98%BF%E9%87%8C%E4%BA%91OSS/">ShokaX主题添加live2d+资源上传阿里云OSS</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/ANNS/" title="分类于ANNS">ANNS</a></div><span><a href="/2024/08/01/ANNS/DF-GAS_%20a%20Distributed%20FPGA-as-a-Service%20Architecture%20towards%20Billion-Scale%20Graph-based%20Approximate%20Nearest%20Neighbor%20Search/">DF-GAS_ a Distributed FPGA-as-a-Service Architecture towards Billion-Scale Graph-based Approximate Nearest Neighbor Search</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/ANNS/" title="分类于ANNS">ANNS</a></div><span><a href="/2024/08/17/ANNS/%E5%86%8D%E8%AF%BBHNSW/">再读HNSW</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/ANNS/" title="分类于ANNS">ANNS</a></div><span><a href="/2024/08/01/ANNS/Product%20Quantization/">Product Quantization</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/ANNS/" title="分类于ANNS">ANNS</a></div><span><a href="/2024/08/09/ANNS/CXL-ANNS/">CXL-ANNS</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/ANNS/" title="分类于ANNS">ANNS</a></div><span><a href="/2024/08/09/ANNS/%E5%9F%BA%E4%BA%8E%E5%9B%BE%E7%9A%84ANNS%E6%9E%84%E5%BB%BA%E7%B4%A2%E5%BC%95%E7%9B%B8%E5%85%B3/">基于图的ANNS构建索引相关</a></span></li></ul></div><div class="rpost pjax"><h2>最新评论</h2><ul class="leancloud-recent-comment" id="new-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2024 -<span itemprop="copyrightYear">2024</span><span class="with-love"><i class="ic i-sakura rotate"></i></span><span class="author" itemprop="copyrightHolder">GuitarYui @ Yyuuz's Wasteland</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i></span><span title="站点总字数">35k 字</span><span class="post-meta-divider"> | </span><span class="post-meta-item-icon"><i class="ic i-coffee"></i></span><span title="站点阅读时长">32 分钟</span></div><div class="powered-by">基于 <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a> & Theme.<a target="_blank" rel="noopener" href="https://github.com/theme-shoka-x/hexo-theme-shokaX/">ShokaX</a><span style="display:block">
<a href="https://icp.gov.moe/?keyword=20244924" target="_blank" data-pjax-state="external">
<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABYAAAAWCAYAAADEtGw7AAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAAB3RJTUUH5AYNFh86L9bWpwAAA7VJREFUOMvFlX1I1WcUxz/P73p/V6/ea9oVralNvWpJDSYGKgvtZc222ZixCiYR7FXW/tiGGxt7Yf/koNpA3D8OoklsbIIbWVRoG64I09uqtUzxZiPfsFJTr/fld7337I9LubhN22DswAMPnPN8znm+h+c88B+ZWixA9nTGcPq3MqZmd4HMkZjQxLrHzqiG4tA/Boe/uYP6snU1o+PV+I2dGMEVOBIgLDAxCxbzdWIt35KafFherbiq7U5ZGCxPt6ThHt6BP7ALX+BxLGYlm3JhfQ5M+0EpSNDhJzfqlBuMUJhY3UVc7GGyl3+nTlTdjAKHnfVvq+nZOkR01mYglavAEgPt/ajuQXilCHpvQdsAUp4NG5zgNeBID/w6BJpmkGSv1XrfqAeIuZchYGwkc4kuH26A7iFUaw90DUacS63wchG4x+FYH+p4LxzvRZbZoSIPakrgkzZdTfrLgXoAbV4HSScvBZovowpT4VAVLLcBAuNeePMo1HVASCLx6XZo2gZ+A1p7wLkUCYXS7uLuVUwobJNECwxOwUk3jHlgdGZerZP993fHG0SFBbxB5I4BdgtK0xzRYIWmNIWEBFquRNZCNuGDpw6BSaFKs8CkIBQmGozyiTcI8WaoKoCWHshzgMUEl8fgiRXw7Eq4NgEHXVCWBc/kgxFCzg2jvEEwab4HVKxG1JhnJTnJULMWOgdh5xoYmorouikHPmqH0gzYUwyBEDR0wvVJ1O4iGJgEkeG7uPnm6THX6L+N5KfA72OwdRXE6+CIh9JMaLoAwRB0/AFptsiZ98tgXwVS+AgMTIBudkeDNe0Mk17IdcDFUSjJhLM3QDdFEj3pjMQ5k8FjRPZ1HVB7ItJgjx/MMWejpcha1s4lt6FcQzojM3DwPHQPgd0SkSU7CQ5sgekA7D8NG3PgrVKwxULXCJi0gOSln6LvQU86Y/+PxJufk/fKUbVHH2qKyRdbUZ+2gSHfqxvv7IiWAsCRuJfx2TD9t5DN+YtTKwtQF0dg2j9HWvJnf3XdD973YhfxcfXqq67IVUse/XtoWQ5SnAlfuyDBeoCG7RcWHJvy/DEd19VWjOBmebccvAaq8Rz4gpEAq47UFINSqM9/AYveKsWrq7TmirlF57Fs+SGOKwONeP3VFKYj1YVw2wOagiQrquk8XBoRbNYm1jhfU0cqAw/9g8jrnYqfXdvwePcSCOaSagcRuDkDsXofS2wfsH19i/o4/19+TS91mOns2cys7wVQYWzWZikpaNMa183xf9ifr1JmED/Jk5sAAAAldEVYdGRhdGU6Y3JlYXRlADIwMjItMDktMjFUMTU6MTU6MjIrMDg6MDAxUkujAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDIwLTA2LTEzVDIyOjMxOjU4KzA4OjAwB9q+2QAAAABJRU5ErkJggg==" style="display:initial;position:relative;top:.5vh" data-loaded="true" class="lozaded">萌ICP备20244924号</a> 
</span></div><div style="width: 100%;text-align:center;"><span id="time"></span></div><script>function createtime() {
    const n = new Date("2024/07/30 00:00:00");
    now.setTime(now.getTime() + 250), days = (now - n) / 1e3 / 60 / 60 / 24, dnum = Math.floor(days), hours = (now - n) / 1e3 / 60 / 60 - 24 * dnum, hnum = Math.floor(hours), 1 == String(hnum).length && (hnum = "0" + hnum), minutes = (now - n) / 1e3 / 60 - 1440 * dnum - 60 * hnum, mnum = Math.floor(minutes), 1 == String(mnum).length && (mnum = "0" + mnum), seconds = (now - n) / 1e3 - 86400 * dnum - 3600 * hnum - 60 * mnum, snum = Math.round(seconds), 1 == String(snum).length && (snum = "0" + snum), document.getElementById("time").innerHTML = "此站已存活" + dnum + " 天 " + hnum + " 小时 " + mnum + " 分 " + snum + " 秒"
}

const now = new Date;
setInterval("createtime()", 250)</script></div><script src="https://unpkg.com/busuanzi@2.3.0/bsz.pure.mini.js"></script><div id="busuanzi-wrap"><span class="ic i-eye"></span><span id="busuanzi_container_site_pv">本站总访问量 <span id="busuanzi_value_site_pv"></span> 次</span> | <span class="ic i-user"></span><span id="busuanzi_container_site_uv">本站总访客量 <span id="busuanzi_value_site_uv"></span> 次</span></div></div></footer></div><script data-config type="text/javascript">var LOCAL = {
    ispost: true,
        path: `2024/08/17/ANNS/再读HNSW/`,
        favicon: {
        show: `（●´3｀●）やれやれだぜ`,
        hide: `(´Д｀)大変だ！`
    },
    search: {
        placeholder: "文章搜索",
        empty: "关于 「 ${query} 」，什么也没搜到",
        stats: "${time} ms 内找到 ${hits} 条结果"
    },
    copy_tex: false,
    katex: false,
    mermaid: false,
    audio: undefined,
    fancybox: true,
    nocopy: false,
    outime: true,
    template: `<div class="note warning"><p><span class="label warning">文章时效性提示</span><br>这是一篇发布于 {{publish}} 天前，最后一次更新在 {{updated}} 天前的文章，部分信息可能已经发生改变，请注意甄别。</p></div>`,
    quiz: {
        choice: `单选题`,
        multiple: `多选题`,
        true_false: `判断题`,
        essay: `问答题`,
        gap_fill: `填空题`,
        mistake: `错题备注`
    },
    ignores: [
        (uri) => uri.includes('#'),
        (uri) => new RegExp(LOCAL.path + '$').test(uri),
            []
    ]
};
</script><script src="https://s4.zstatic.net/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha384-k6YtvFUEIuEFBdrLKJ3YAUbBki333tj1CSUisai5Cswsg9wcLNaPzsTHDswp4Az8" crossorigin="anonymous" fetchpriority="high"></script><script src="https://s4.zstatic.net/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha384-ZvpUoO&#x2F;+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn&#x2F;6Z&#x2F;hRTt8+pR6L4N2" crossorigin="anonymous" fetchpriority="high"></script><script src="/js/siteInit.js?v=0.4.11" type="module" fetchpriority="high" defer></script></body></html><script src="/live2d-widget/autoload.js"></script>